Return-Path: <linux-xfs-owner@vger.kernel.org>
X-Original-To: lists+linux-xfs@lfdr.de
Delivered-To: lists+linux-xfs@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 8002A39FD74
	for <lists+linux-xfs@lfdr.de>; Tue,  8 Jun 2021 19:19:58 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232516AbhFHRVn (ORCPT <rfc822;lists+linux-xfs@lfdr.de>);
        Tue, 8 Jun 2021 13:21:43 -0400
Received: from mail.kernel.org ([198.145.29.99]:54960 "EHLO mail.kernel.org"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S233005AbhFHRVm (ORCPT <rfc822;linux-xfs@vger.kernel.org>);
        Tue, 8 Jun 2021 13:21:42 -0400
Received: by mail.kernel.org (Postfix) with ESMTPSA id CDEBE61351;
        Tue,  8 Jun 2021 17:19:49 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1623172789;
        bh=WJ/52PV7jPHSVREjaQ72TU2RotOg9bwNThPV40DcTuM=;
        h=Subject:From:To:Cc:Date:In-Reply-To:References:From;
        b=QXwWj5Y5Qhka0Br6W4v3E3UPTvzwuMznRlIO6qdrENQh7VcC8kbd/XDqXfzZ6g+GC
         0oQSlRaEXF40hMCHPOqnQyW4AWeuheCJtKAyvIuqKRjUNgRncan6XiviKqWTd0Qrzp
         2gQqy/K6zCv8iCKsP+ycsmE8OCCBO5YqsxKdKs/MBnfPZ9wCJFTutdoM8mtGfARC3h
         chyMJ4hCNyu1gRdq4oZmTLWbFaTWLPF+SKGxfDZHTfdgtrl5VJMPMgWBctbi9g1vGa
         WojnVit0bfckoGt54f63bWRw7c081AoPpTt2Da6PzN6L6wHzagVPuAjsahcMsM44yR
         2AzRrXm3iR3IA==
Subject: [PATCH 05/13] fstests: move test group info to test files
From:   "Darrick J. Wong" <djwong@kernel.org>
To:     djwong@kernel.org, guaneryu@gmail.com
Cc:     linux-xfs@vger.kernel.org, fstests@vger.kernel.org, guan@eryu.me,
        amir73il@gmail.com, ebiggers@kernel.org
Date:   Tue, 08 Jun 2021 10:19:49 -0700
Message-ID: <162317278957.653489.1221763643277904130.stgit@locust>
In-Reply-To: <162317276202.653489.13006238543620278716.stgit@locust>
References: <162317276202.653489.13006238543620278716.stgit@locust>
User-Agent: StGit/0.19
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-xfs.vger.kernel.org>
X-Mailing-List: linux-xfs@vger.kernel.org

From: Darrick J. Wong <djwong@kernel.org>

Refactor every test in the entire test suite to use the new boilerplate
functions.  This also migrates all the test group information into the
test files.  This patch has been autogenerated via the command:

./tools/convert-group btrfs ceph cifs ext4 f2fs generic nfs ocfs2 overlay perf shared udf xfs

NOTE: This patch submission only contains diffs of the first seven btrfs
tests because vger rejects 1.5MB patches.  The full conversion is in the
git branch linked from the cover letter.

Signed-off-by: Darrick J. Wong <djwong@kernel.org>
---
 tests/btrfs/001 |   15 ++++-----------
 tests/btrfs/002 |   15 ++++-----------
 tests/btrfs/003 |   15 ++++-----------
 tests/btrfs/004 |   15 ++++-----------
 tests/btrfs/005 |   16 ++++------------
 tests/btrfs/006 |   16 ++++------------
 6 files changed, 24 insertions(+), 68 deletions(-)


diff --git a/tests/btrfs/001 b/tests/btrfs/001
index fb051e8a..5d5849f0 100755
--- a/tests/btrfs/001
+++ b/tests/btrfs/001
@@ -6,23 +6,16 @@
 #
 # Test btrfs's subvolume and snapshot support
 #
-seq=`basename $0`
-seqres=$RESULT_DIR/$seq
-echo "QA output created by $seq"
-
-here=`pwd`
-tmp=/tmp/$$
-status=1	# failure is the default!
+. ./common/preamble
+_begin_fstest auto quick subvol snapshot
 
+# Override the default cleanup function.
 _cleanup()
 {
     rm -f $tmp.*
 }
 
-trap "_cleanup ; exit \$status" 0 1 2 3 15
-
-# get standard environment, filters and checks
-. ./common/rc
+# Import common functions.
 . ./common/filter
 . ./common/filter.btrfs
 
diff --git a/tests/btrfs/002 b/tests/btrfs/002
index 66775562..96332271 100755
--- a/tests/btrfs/002
+++ b/tests/btrfs/002
@@ -6,23 +6,16 @@
 #
 # Extented btrfs snapshot test cases
 #
-seq=`basename $0`
-seqres=$RESULT_DIR/$seq
-echo "QA output created by $seq"
-
-here=`pwd`
-tmp=/tmp/$$
-status=1	# failure is the default!
+. ./common/preamble
+_begin_fstest auto snapshot
 
+# Override the default cleanup function.
 _cleanup()
 {
     rm -f $tmp.*
 }
 
-trap "_cleanup ; exit \$status" 0 1 2 3 15
-
-# get standard environment, filters and checks
-. ./common/rc
+# Import common functions.
 . ./common/filter
 
 _supported_fs btrfs
diff --git a/tests/btrfs/003 b/tests/btrfs/003
index fbb313fb..d241ec6e 100755
--- a/tests/btrfs/003
+++ b/tests/btrfs/003
@@ -6,16 +6,11 @@
 #
 # btrfs vol tests
 #
-seq=`basename $0`
-seqres=$RESULT_DIR/$seq
-echo "QA output created by $seq"
+. ./common/preamble
+_begin_fstest auto replace volume balance
 
-here=`pwd`
-tmp=/tmp/$$
-status=1	# failure is the default!
 dev_removed=0
 removed_dev_htl=""
-trap "_cleanup; exit \$status" 0 1 2 3 15
 
 # Check if all scratch dev pools are deletable
 deletable_scratch_dev_pool()
@@ -32,6 +27,7 @@ deletable_scratch_dev_pool()
 	return 0
 }
 
+# Override the default cleanup function.
 _cleanup()
 {
     cd /
@@ -42,8 +38,7 @@ _cleanup()
     fi
 }
 
-# get standard environment, filters and checks
-. ./common/rc
+# Import common functions.
 . ./common/filter
 
 _supported_fs btrfs
@@ -51,8 +46,6 @@ _require_scratch
 _require_scratch_dev_pool 4
 _require_command "$WIPEFS_PROG" wipefs
 
-rm -f $seqres.full
-
 # Test cases related to raid in btrfs
 _test_raid0()
 {
diff --git a/tests/btrfs/004 b/tests/btrfs/004
index 0458d2b6..4e767a2f 100755
--- a/tests/btrfs/004
+++ b/tests/btrfs/004
@@ -9,25 +9,20 @@
 # run filefrag to get the extent mapping and follow the backrefs.
 # We check to end up back at the original file with the correct offset.
 #
-seq=`basename $0`
-seqres=$RESULT_DIR/$seq
-echo "QA output created by $seq"
+. ./common/preamble
+_begin_fstest auto rw metadata
 
-here=`pwd`
-tmp=/tmp/$$
-status=1
 noise_pid=0
 
+# Override the default cleanup function.
 _cleanup()
 {
 	rm $tmp.running
 	wait
 	rm -f $tmp.*
 }
-trap "_cleanup; exit \$status" 0 1 2 3 15
 
-# get standard environment, filters and checks
-. ./common/rc
+# Import common functions.
 . ./common/filter
 
 # real QA test starts here
@@ -38,8 +33,6 @@ _require_btrfs_command inspect-internal logical-resolve
 _require_btrfs_command inspect-internal inode-resolve
 _require_command "$FILEFRAG_PROG" filefrag
 
-rm -f $seqres.full
-
 FILEFRAG_FILTER='
 	if (/blocks? of (\d+) bytes/) {
 		$blocksize = $1;
diff --git a/tests/btrfs/005 b/tests/btrfs/005
index ff20a638..ac9e8bfa 100755
--- a/tests/btrfs/005
+++ b/tests/btrfs/005
@@ -6,17 +6,12 @@
 #
 # Btrfs Online defragmentation tests
 #
-seq=`basename $0`
-seqres=$RESULT_DIR/$seq
-echo "QA output created by $seq"
-here="`pwd`"
-tmp=/tmp/$$
+. ./common/preamble
+_begin_fstest auto defrag
 cnt=119
 filesize=48000
 
-status=1	# failure is the default!
-trap "_cleanup; exit \$status" 0 1 2 3 15
-
+# Override the default cleanup function.
 _cleanup()
 {
     cd /
@@ -111,8 +106,7 @@ _rundefrag()
 	_check_scratch_fs
 }
 
-# get standard environment, filters and checks
-. ./common/rc
+# Import common functions.
 . ./common/filter
 . ./common/defrag
 
@@ -120,8 +114,6 @@ _rundefrag()
 _supported_fs btrfs
 _require_scratch
 
-rm -f $seqres.full
-
 _scratch_mkfs >/dev/null 2>&1
 _scratch_mount
 _require_defrag
diff --git a/tests/btrfs/006 b/tests/btrfs/006
index 67f1fcd8..c0f9541a 100755
--- a/tests/btrfs/006
+++ b/tests/btrfs/006
@@ -7,23 +7,17 @@
 # run basic btrfs information commands in various ways
 # sanity tests: filesystem show, label, sync, and device stats
 #
-seq=`basename $0`
-seqres=$RESULT_DIR/$seq
-echo "== QA output created by $seq"
-
-here=`pwd`
-tmp=/tmp/$$
-status=1	# failure is the default!
-trap "_cleanup; exit \$status" 0 1 2 3 15
+. ./common/preamble
+_begin_fstest auto quick volume
 
+# Override the default cleanup function.
 _cleanup()
 {
     cd /
     rm -f $tmp.*
 }
 
-# get standard environment, filters and checks
-. ./common/rc
+# Import common functions.
 . ./common/filter.btrfs
 
 # real QA test starts here
@@ -33,8 +27,6 @@ _supported_fs btrfs
 _require_scratch
 _require_scratch_dev_pool
 
-rm -f $seqres.full
-
 FIRST_POOL_DEV=`echo $SCRATCH_DEV_POOL | awk '{print $1}'`
 LAST_POOL_DEV=`echo $SCRATCH_DEV_POOL | awk '{print $NF}'`
 TOTAL_DEVS=`echo $SCRATCH_DEV_POOL | wc -w`

