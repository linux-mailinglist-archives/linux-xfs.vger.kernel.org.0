Return-Path: <linux-xfs-owner@vger.kernel.org>
X-Original-To: lists+linux-xfs@lfdr.de
Delivered-To: lists+linux-xfs@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id DE0B23A3C6A
	for <lists+linux-xfs@lfdr.de>; Fri, 11 Jun 2021 08:57:20 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230382AbhFKG7R (ORCPT <rfc822;lists+linux-xfs@lfdr.de>);
        Fri, 11 Jun 2021 02:59:17 -0400
Received: from mail-pl1-f178.google.com ([209.85.214.178]:41928 "EHLO
        mail-pl1-f178.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230272AbhFKG7L (ORCPT
        <rfc822;linux-xfs@vger.kernel.org>); Fri, 11 Jun 2021 02:59:11 -0400
Received: by mail-pl1-f178.google.com with SMTP id e1so2351594plh.8;
        Thu, 10 Jun 2021 23:56:58 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=references:user-agent:from:to:cc:subject:in-reply-to:date
         :message-id:mime-version;
        bh=FGk0hkp4y7ReM7Ri7a+9GpX2Oq3xfzRymG2Aaw0k6Nc=;
        b=fMpnKV+FcQktHGw2Jc6HrsTb2bdFrfS56COQRnMXDBwgdgqnAfilJJvmVtsVh0XmX5
         C9wbIjfCD+3TzpzHKrgIx900jvu7F/NPtdC1VFIHJ9Q74IR3CRp8IF5EHFBaVoSDU6Fz
         XLtAcm95P6UBSjc2x18GIsqxQP6/lVcjc6rA13HtzYOJXpUpCLylDK+xqhIu9YHUGZx/
         zClaYXzOcT1yo5/L8NHnNW0/nR35MZSqDzYSEa8ePmhwe1hrKIBOa/qkH35xpHVE/iJ9
         wnnDtL4ReSB8Ofj9UQpWSBzIQBVLH6Rk1VPNDYRBJGNGs8mmbe7hOuEbMBV6sVQlqc3T
         HChg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:references:user-agent:from:to:cc:subject
         :in-reply-to:date:message-id:mime-version;
        bh=FGk0hkp4y7ReM7Ri7a+9GpX2Oq3xfzRymG2Aaw0k6Nc=;
        b=BGarQoPc5qymgoS0WYgjCFwcSG4R5Rmu1rFTkOO+zxCRJkjo3AGuazXksiWkH1AaNc
         03QAR1/PueQJCS6NRs2Io8hX4MTiqToc8qHglFDaOko2T6DdFxn1uXvXG72uSoMQ0+J7
         rAstinig7RhJg6YUl2wRNAV4PCZRByqy96wbU0+ikA/I/bpNtfQfLJjW0bHsGEOQhffc
         XBVRfuluFkciZOZfJeWhaqjB9FEsjZsoV+kZHCBFNKJpRuA0Hc+2o3ARPustZ6gaER8E
         195VbyVs0B1ZcGVL3qzUNvb2Wvn18OudGhKNaPARu2QlHrk0yemP0G4+KHzCiWvXwM6V
         wLHg==
X-Gm-Message-State: AOAM533zIRQq45ZPbCmFo7tjmkIkXTU5ZwHPmG0PY2cxQ7F196cg2YeL
        rAfMFcGyzw4QIG4mWPoqZOY=
X-Google-Smtp-Source: ABdhPJy9DeFfmzdYWDZUqPWG4REVHVlmyB2Wz5SomWLVaS8hfpF5RUnoYJpJ/JcjgtggHNEtPaVgbQ==
X-Received: by 2002:a17:90a:e409:: with SMTP id hv9mr7662551pjb.126.1623394558681;
        Thu, 10 Jun 2021 23:55:58 -0700 (PDT)
Received: from garuda ([171.61.74.194])
        by smtp.gmail.com with ESMTPSA id p19sm9339249pjv.21.2021.06.10.23.55.56
        (version=TLS1_2 cipher=ECDHE-ECDSA-CHACHA20-POLY1305 bits=256/256);
        Thu, 10 Jun 2021 23:55:58 -0700 (PDT)
References: <162317276202.653489.13006238543620278716.stgit@locust> <162317281137.653489.16228043613270527911.stgit@locust>
User-agent: mu4e 1.0; emacs 26.1
From:   Chandan Babu R <chandanrlinux@gmail.com>
To:     "Darrick J. Wong" <djwong@kernel.org>
Cc:     guaneryu@gmail.com, linux-xfs@vger.kernel.org,
        fstests@vger.kernel.org, guan@eryu.me, amir73il@gmail.com,
        ebiggers@kernel.org
Subject: Re: [PATCH 09/13] fstests: adapt the new test script to our new group tagging scheme
In-reply-to: <162317281137.653489.16228043613270527911.stgit@locust>
Date:   Fri, 11 Jun 2021 12:25:54 +0530
Message-ID: <87tum43n5x.fsf@garuda>
MIME-Version: 1.0
Content-Type: text/plain
Precedence: bulk
List-ID: <linux-xfs.vger.kernel.org>
X-Mailing-List: linux-xfs@vger.kernel.org

On 08 Jun 2021 at 22:50, Darrick J. Wong wrote:
> From: Darrick J. Wong <djwong@kernel.org>
>
> Now that we autogenerate group files, adapt the new test creation script
> to use autogenerated group files and to set the group data in the new
> test.
>
> Signed-off-by: Darrick J. Wong <djwong@kernel.org>
> ---
>  new |  179 ++++++++++++++++++++-----------------------------------------------
>  1 file changed, 54 insertions(+), 125 deletions(-)
>
>
> diff --git a/new b/new
> index 16e7c782..cdd909ad 100755
> --- a/new
> +++ b/new
> @@ -9,7 +9,8 @@
>  iam=new
>  . ./common/test_names
>  
> -trap "rm -f /tmp/$$.; exit" 0 1 2 3 15
> +tmpfile="/tmp/$$."
> +trap "rm -f $tmpfile; exit" 0 1 2 3 15
>  
>  _cleanup()
>  {
> @@ -26,71 +27,18 @@ usage()
>  
>  [ $# -eq 0 ] && usage
>  tdir=tests/$1
> -shift
> -
> -if [ ! -f $tdir/group ]
> -then
> -    echo "Creating the $tdir/group index ..."
> -    cat <<'End-of-File' >$tdir/group
> -# QA groups control
> -#
> -# define groups and default group owners
> -# do not start group name with a digit
> -#
> -
> -# catch-all
> -#
> -other		some-user-login
> -
> -# test-group association ... one line per test
> -#
> -End-of-File
> -fi
> -
> -if [ ! -w $tdir/group ]
> -then
> -    chmod u+w $tdir/group
> -    echo "Warning: making the index file \"$tdir/group\" writeable"
> -fi
> -
> -if make
> -then
> -    :
> -else
> -    echo "Warning: make failed -- some tests may be missing"
> -fi
>  
>  i=0
>  line=0
>  eof=1
> -[ -f "$tdir/group" ] || usage
> +[ -d "$tdir/" ] || usage
>  
>  export AWK_PROG="$(type -P awk)"
>  [ "$AWK_PROG" = "" ] && { echo "awk not found"; exit; }
>  
> -for found in `cat $tdir/group | tr - ' ' | $AWK_PROG '{ print $1 }'`
> -do
> -    line=$((line+1))
> -    if [ -z "$found" ] || [ "$found" == "#" ]; then
> -        continue
> -    elif ! echo "$found" | grep -q "^$VALID_TEST_NAME$"; then
> -        # this one is for tests not named by a number
> -        continue
> -    fi
> -    i=$((i+1))
> -    id=`printf "%03d" $i`
> -    if [ "$id" != "$found" ];then
> -	eof=0
> -	break
> -    fi
> -done
> -if [ $eof -eq 1 ]; then
> -   line=$((line+1))
> -   i=$((i+1))
> -   id=`printf "%03d" $i`
> -fi
> -
> +id="$(basename "$(./tools/nextid "$1")")"
>  echo "Next test id is $id"
> +shift
>  
>  read -p "Append a name to the ID? Test name will be $id-\$name. y,[n]: " -r
>  if [[ $REPLY = [Yy] ]]; then
> @@ -113,24 +61,9 @@ if [[ $REPLY = [Yy] ]]; then
>  		fi
>  	done
>  
> -	# now find where to insert this name
> -	eof=1
> -	for found in `tail -n +$line $tdir/group | $AWK_PROG '{ print $1 }'`; do
> -		found_id=$(echo "$found" | cut -d "-" -f 1 - )
> -		line=$((line+1))
> -		if [ -z "$found" ] || [ "$found" == "#" ]; then
> -			continue
> -		elif [ $found_id -gt $id ]; then
> -			eof=0
> -			break
> -		fi
> -	done
> -	if [ $eof -eq 0 ]; then
> -		# If place wasn't found, let $line be the end of the file
> -		line=$((line-1))
> -	fi
>  	id="$id-$name"
>  fi
> +
>  echo "Creating test file '$id'"
>  
>  if [ -f $tdir/$id ]
> @@ -140,6 +73,53 @@ then
>      exit 1
>  fi
>  
> +if [ $# -eq 0 ]
> +then
> +
> +    while true
> +    do
> +	echo -n "Add to group(s) [other] (separate by space, ? for list): "
> +	read ans
> +	[ -z "$ans" ] && ans=other
> +	if [ "X$ans" = "X?" ]
> +	then
> +	    for d in $SRC_GROUPS; do
> +		(cd "tests/$d/" ; ../../tools/mkgroupfile "$tmpfile")
> +		l=$(set -n < "$tmpfile" \

The above should have been "sed" instead of "set".

Apart from the above nit, the rest looks good to me.

Reviewed-by: Chandan Babu R <chandanrlinux@gmail.com>

-- 
chandan
