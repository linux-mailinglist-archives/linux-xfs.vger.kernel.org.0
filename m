Return-Path: <linux-xfs-owner@vger.kernel.org>
X-Original-To: lists+linux-xfs@lfdr.de
Delivered-To: lists+linux-xfs@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 400403A70D7
	for <lists+linux-xfs@lfdr.de>; Mon, 14 Jun 2021 22:59:25 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S234686AbhFNVBD (ORCPT <rfc822;lists+linux-xfs@lfdr.de>);
        Mon, 14 Jun 2021 17:01:03 -0400
Received: from mail.kernel.org ([198.145.29.99]:47172 "EHLO mail.kernel.org"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S233438AbhFNVBD (ORCPT <rfc822;linux-xfs@vger.kernel.org>);
        Mon, 14 Jun 2021 17:01:03 -0400
Received: by mail.kernel.org (Postfix) with ESMTPSA id A70B8601FC;
        Mon, 14 Jun 2021 20:58:59 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1623704339;
        bh=cMHHKXEhgSN/qU3wyKkcWDOqzWlLR9l7uyxeP6Xke5w=;
        h=Subject:From:To:Cc:Date:From;
        b=jrw4lsb2dFMmHfOFSUKELauvfexO+K4lO/NN/+LwaoVasVd4J4mXkWwKXjcfi4dEH
         GLHLqTrmRKt9gOE99EtT3q5NQJEd5Xw5O6kuBorOfsylN49z/6Jj028oa5/CJsa5a+
         ziN3V34ktyhfA4LkxOTgBLVPhy79W8dYzYHUwitGr4nISKnZ42cfLqpB/fz+X07sxh
         W+Nv75MCtWssUNgSh6+8nVZW0ERm2WVtaP4mIAmPqNiueeE2HdgQmxGQCy6kE7Nh2l
         9zysJcms0RGosHr3wMfVZyjNzIn4Q0Vf2AoWkIaHrCoymZIa8R7zxSQx9QIEzjXv64
         i68P2GbWq3vMA==
Subject: [PATCHSET v2 00/13] fstests: move test group lists into test files
From:   "Darrick J. Wong" <djwong@kernel.org>
To:     djwong@kernel.org, guaneryu@gmail.com
Cc:     Allison Henderson <allison.henderson@oracle.com>,
        Chandan Babu R <chandanrlinux@gmail.com>,
        linux-xfs@vger.kernel.org, fstests@vger.kernel.org, guan@eryu.me,
        amir73il@gmail.com, ebiggers@kernel.org
Date:   Mon, 14 Jun 2021 13:58:59 -0700
Message-ID: <162370433910.3800603.9623820748404628250.stgit@locust>
User-Agent: StGit/0.19
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-xfs.vger.kernel.org>
X-Mailing-List: linux-xfs@vger.kernel.org

Hi all,

Test group files (e.g. tests/generic/group) are a pain to keep up.
Every week I rebase on Eryu's latest upstream, and every week I have to
slog through dozens of trivial merge conflicts because of the
groupfiles.  Moving tests is annoying because we have to maintain all
this code to move the group associations from one /group file to
another.

It doesn't need to be this way -- we could move each test's group
information into the test itself, and automatically generate the group
files as part of the make process.  This series does exactly that.

The first few patches add some convenient anchors for the new
per-testfile group tagging and a conversion script to migrate existing
test files.  Next there's a huge patch that is the results of running
the conversion script, followed by cleanup of the golden outputs.  After
that comes the build infrastructure to generate group files and other
tweaks to the existing maintainer scripts to use the new infrastructure.
Finally, remove the group files themselves and the (now unnecessary)
code that maintained them.

v1: promote from rfc, use group.list for autogenerated group files, fix
    odd build warts, rename preamble function, update readme
v2: add reviews, remove _cleanup functions that mirror the standard one,
    use rm -rf to clean $tmp.*

If you're going to start using this mess, you probably ought to just
pull from my git trees, which are linked below.

This is an extraordinary way to destroy everything.  Enjoy!
Comments and questions are, as always, welcome.

--D

fstests git tree:
https://git.kernel.org/cgit/linux/kernel/git/djwong/xfstests-dev.git/log/?h=autogenerate-groupfiles-5.14
---
 .gitignore             |    3 
 README                 |   19 +
 check                  |    6 
 common/preamble        |   57 ++++
 include/buildgrouplist |    8 +
 new                    |  217 +++++-----------
 tests/Makefile         |    4 
 tests/btrfs/001        |   19 -
 tests/btrfs/002        |   19 -
 tests/btrfs/003        |   15 -
 tests/btrfs/004        |   15 -
 tests/btrfs/005        |   21 --
 tests/btrfs/006        |   21 --
 tests/btrfs/006.out    |    2 
 tests/btrfs/012.out    |    2 
 tests/btrfs/Makefile   |    6 
 tests/btrfs/group      |  246 ------------------
 tests/ceph/Makefile    |    6 
 tests/ceph/group       |    4 
 tests/cifs/Makefile    |    6 
 tests/cifs/group       |    6 
 tests/ext4/Makefile    |    6 
 tests/ext4/group       |   64 -----
 tests/f2fs/Makefile    |    6 
 tests/f2fs/group       |    7 -
 tests/generic/068      |    3 
 tests/generic/184.out  |    2 
 tests/generic/Makefile |    6 
 tests/generic/group    |  643 ------------------------------------------------
 tests/nfs/Makefile     |    6 
 tests/nfs/group        |    6 
 tests/ocfs2/Makefile   |    6 
 tests/ocfs2/group      |    1 
 tests/overlay/Makefile |    6 
 tests/overlay/group    |  100 -------
 tests/perf/Makefile    |    6 
 tests/perf/group       |    1 
 tests/shared/Makefile  |    6 
 tests/shared/group     |    8 -
 tests/udf/Makefile     |    6 
 tests/udf/group        |    6 
 tests/xfs/004          |    3 
 tests/xfs/Makefile     |    6 
 tests/xfs/group        |  534 ----------------------------------------
 tools/convert-group    |  138 ++++++++++
 tools/mkgroupfile      |   42 +++
 tools/mvtest           |   12 -
 tools/nextid           |    1 
 tools/nextid           |   31 ++
 tools/sort-group       |  112 --------
 50 files changed, 459 insertions(+), 2017 deletions(-)
 create mode 100644 common/preamble
 create mode 100644 include/buildgrouplist
 delete mode 100644 tests/btrfs/group
 delete mode 100644 tests/ceph/group
 delete mode 100644 tests/cifs/group
 delete mode 100644 tests/ext4/group
 delete mode 100644 tests/f2fs/group
 delete mode 100644 tests/generic/group
 delete mode 100644 tests/nfs/group
 delete mode 100644 tests/ocfs2/group
 delete mode 100644 tests/overlay/group
 delete mode 100644 tests/perf/group
 delete mode 100644 tests/shared/group
 delete mode 100644 tests/udf/group
 delete mode 100644 tests/xfs/group
 create mode 100755 tools/convert-group
 create mode 100755 tools/mkgroupfile
 delete mode 120000 tools/nextid
 create mode 100755 tools/nextid
 delete mode 100755 tools/sort-group

