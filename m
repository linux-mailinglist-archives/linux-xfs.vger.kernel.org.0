Return-Path: <linux-xfs-owner@vger.kernel.org>
X-Original-To: lists+linux-xfs@lfdr.de
Delivered-To: lists+linux-xfs@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 9B8193A70DF
	for <lists+linux-xfs@lfdr.de>; Mon, 14 Jun 2021 22:59:43 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S234952AbhFNVBb (ORCPT <rfc822;lists+linux-xfs@lfdr.de>);
        Mon, 14 Jun 2021 17:01:31 -0400
Received: from mail.kernel.org ([198.145.29.99]:48628 "EHLO mail.kernel.org"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S234280AbhFNVBa (ORCPT <rfc822;linux-xfs@vger.kernel.org>);
        Mon, 14 Jun 2021 17:01:30 -0400
Received: by mail.kernel.org (Postfix) with ESMTPSA id 18371601FC;
        Mon, 14 Jun 2021 20:59:27 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1623704367;
        bh=MMPtuLmY24BSHC/LpwA8Y+biuRkRsn4A3PUfvOLRV10=;
        h=Subject:From:To:Cc:Date:In-Reply-To:References:From;
        b=vHqmtMLF6oymMl35jny9Kjf6q4fZJLIQjp+OrXkfdcZGWirZpP4zFNXUqxCNVoeqa
         7vZT31i072Aw6paCq0cW5ASFXt0WjfemZj365fnA1jkmAMQ8iiVWqHyQnKsIrK3ivy
         RgSvum//0rwx6DJKkC8WkutIvxj6GYjPNoD1VrnEtZGhv176BvWvXFhVlh94YRDtcE
         wXJ9hJY0B4fSdJ3Co6Z+5oBMGFts7hvgRmqV8KnmpuXKQIxSrklxLVfLRFmPfjHfjx
         LBYWM0gcyYdWkOzpORXRpZjOFJaO8lAJyyn460y5GX+C6bwPxttqb+DES/UvUHSaOq
         WL/nPp17qw7BA==
Subject: [PATCH 05/13] fstests: move test group info to test files
From:   "Darrick J. Wong" <djwong@kernel.org>
To:     djwong@kernel.org, guaneryu@gmail.com
Cc:     Allison Henderson <allison.henderson@oracle.com>,
        linux-xfs@vger.kernel.org, fstests@vger.kernel.org, guan@eryu.me,
        amir73il@gmail.com, ebiggers@kernel.org
Date:   Mon, 14 Jun 2021 13:59:26 -0700
Message-ID: <162370436680.3800603.3592918737641309773.stgit@locust>
In-Reply-To: <162370433910.3800603.9623820748404628250.stgit@locust>
References: <162370433910.3800603.9623820748404628250.stgit@locust>
User-Agent: StGit/0.19
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-xfs.vger.kernel.org>
X-Mailing-List: linux-xfs@vger.kernel.org

From: Darrick J. Wong <djwong@kernel.org>

Refactor every test in the entire test suite to use the new boilerplate
functions.  This also migrates all the test group information into the
test files.  This patch has been autogenerated via the command:

./tools/convert-group btrfs ceph cifs ext4 f2fs generic nfs ocfs2 overlay perf shared udf xfs

NOTE: This patch submission only contains diffs of the first seven btrfs
tests because vger rejects 1.5MB patches.  The full conversion is in the
git branch linked from the cover letter.

Signed-off-by: Darrick J. Wong <djwong@kernel.org>
Reviewed-by: Allison Henderson <allison.henderson@oracle.com>
---
 tests/btrfs/001 |   19 +++----------------
 tests/btrfs/002 |   19 +++----------------
 tests/btrfs/003 |   15 ++++-----------
 tests/btrfs/004 |   15 ++++-----------
 tests/btrfs/005 |   21 +++------------------
 tests/btrfs/006 |   21 +++------------------
 6 files changed, 20 insertions(+), 90 deletions(-)


diff --git a/tests/btrfs/001 b/tests/btrfs/001
index fb051e8a..000aeb34 100755
--- a/tests/btrfs/001
+++ b/tests/btrfs/001
@@ -6,23 +6,10 @@
 #
 # Test btrfs's subvolume and snapshot support
 #
-seq=`basename $0`
-seqres=$RESULT_DIR/$seq
-echo "QA output created by $seq"
+. ./common/preamble
+_begin_fstest auto quick subvol snapshot
 
-here=`pwd`
-tmp=/tmp/$$
-status=1	# failure is the default!
-
-_cleanup()
-{
-    rm -f $tmp.*
-}
-
-trap "_cleanup ; exit \$status" 0 1 2 3 15
-
-# get standard environment, filters and checks
-. ./common/rc
+# Import common functions.
 . ./common/filter
 . ./common/filter.btrfs
 
diff --git a/tests/btrfs/002 b/tests/btrfs/002
index 66775562..58f0cdcd 100755
--- a/tests/btrfs/002
+++ b/tests/btrfs/002
@@ -6,23 +6,10 @@
 #
 # Extented btrfs snapshot test cases
 #
-seq=`basename $0`
-seqres=$RESULT_DIR/$seq
-echo "QA output created by $seq"
+. ./common/preamble
+_begin_fstest auto snapshot
 
-here=`pwd`
-tmp=/tmp/$$
-status=1	# failure is the default!
-
-_cleanup()
-{
-    rm -f $tmp.*
-}
-
-trap "_cleanup ; exit \$status" 0 1 2 3 15
-
-# get standard environment, filters and checks
-. ./common/rc
+# Import common functions.
 . ./common/filter
 
 _supported_fs btrfs
diff --git a/tests/btrfs/003 b/tests/btrfs/003
index fbb313fb..d241ec6e 100755
--- a/tests/btrfs/003
+++ b/tests/btrfs/003
@@ -6,16 +6,11 @@
 #
 # btrfs vol tests
 #
-seq=`basename $0`
-seqres=$RESULT_DIR/$seq
-echo "QA output created by $seq"
+. ./common/preamble
+_begin_fstest auto replace volume balance
 
-here=`pwd`
-tmp=/tmp/$$
-status=1	# failure is the default!
 dev_removed=0
 removed_dev_htl=""
-trap "_cleanup; exit \$status" 0 1 2 3 15
 
 # Check if all scratch dev pools are deletable
 deletable_scratch_dev_pool()
@@ -32,6 +27,7 @@ deletable_scratch_dev_pool()
 	return 0
 }
 
+# Override the default cleanup function.
 _cleanup()
 {
     cd /
@@ -42,8 +38,7 @@ _cleanup()
     fi
 }
 
-# get standard environment, filters and checks
-. ./common/rc
+# Import common functions.
 . ./common/filter
 
 _supported_fs btrfs
@@ -51,8 +46,6 @@ _require_scratch
 _require_scratch_dev_pool 4
 _require_command "$WIPEFS_PROG" wipefs
 
-rm -f $seqres.full
-
 # Test cases related to raid in btrfs
 _test_raid0()
 {
diff --git a/tests/btrfs/004 b/tests/btrfs/004
index 0458d2b6..4e767a2f 100755
--- a/tests/btrfs/004
+++ b/tests/btrfs/004
@@ -9,25 +9,20 @@
 # run filefrag to get the extent mapping and follow the backrefs.
 # We check to end up back at the original file with the correct offset.
 #
-seq=`basename $0`
-seqres=$RESULT_DIR/$seq
-echo "QA output created by $seq"
+. ./common/preamble
+_begin_fstest auto rw metadata
 
-here=`pwd`
-tmp=/tmp/$$
-status=1
 noise_pid=0
 
+# Override the default cleanup function.
 _cleanup()
 {
 	rm $tmp.running
 	wait
 	rm -f $tmp.*
 }
-trap "_cleanup; exit \$status" 0 1 2 3 15
 
-# get standard environment, filters and checks
-. ./common/rc
+# Import common functions.
 . ./common/filter
 
 # real QA test starts here
@@ -38,8 +33,6 @@ _require_btrfs_command inspect-internal logical-resolve
 _require_btrfs_command inspect-internal inode-resolve
 _require_command "$FILEFRAG_PROG" filefrag
 
-rm -f $seqres.full
-
 FILEFRAG_FILTER='
 	if (/blocks? of (\d+) bytes/) {
 		$blocksize = $1;
diff --git a/tests/btrfs/005 b/tests/btrfs/005
index ff20a638..878a8c7c 100755
--- a/tests/btrfs/005
+++ b/tests/btrfs/005
@@ -6,23 +6,11 @@
 #
 # Btrfs Online defragmentation tests
 #
-seq=`basename $0`
-seqres=$RESULT_DIR/$seq
-echo "QA output created by $seq"
-here="`pwd`"
-tmp=/tmp/$$
+. ./common/preamble
+_begin_fstest auto defrag
 cnt=119
 filesize=48000
 
-status=1	# failure is the default!
-trap "_cleanup; exit \$status" 0 1 2 3 15
-
-_cleanup()
-{
-    cd /
-    rm -f $tmp.*
-}
-
 _create_file()
 {
 	if [ $1 -ne 2 ]; then
@@ -111,8 +99,7 @@ _rundefrag()
 	_check_scratch_fs
 }
 
-# get standard environment, filters and checks
-. ./common/rc
+# Import common functions.
 . ./common/filter
 . ./common/defrag
 
@@ -120,8 +107,6 @@ _rundefrag()
 _supported_fs btrfs
 _require_scratch
 
-rm -f $seqres.full
-
 _scratch_mkfs >/dev/null 2>&1
 _scratch_mount
 _require_defrag
diff --git a/tests/btrfs/006 b/tests/btrfs/006
index 67f1fcd8..fd0f89e2 100755
--- a/tests/btrfs/006
+++ b/tests/btrfs/006
@@ -7,23 +7,10 @@
 # run basic btrfs information commands in various ways
 # sanity tests: filesystem show, label, sync, and device stats
 #
-seq=`basename $0`
-seqres=$RESULT_DIR/$seq
-echo "== QA output created by $seq"
+. ./common/preamble
+_begin_fstest auto quick volume
 
-here=`pwd`
-tmp=/tmp/$$
-status=1	# failure is the default!
-trap "_cleanup; exit \$status" 0 1 2 3 15
-
-_cleanup()
-{
-    cd /
-    rm -f $tmp.*
-}
-
-# get standard environment, filters and checks
-. ./common/rc
+# Import common functions.
 . ./common/filter.btrfs
 
 # real QA test starts here
@@ -33,8 +20,6 @@ _supported_fs btrfs
 _require_scratch
 _require_scratch_dev_pool
 
-rm -f $seqres.full
-
 FIRST_POOL_DEV=`echo $SCRATCH_DEV_POOL | awk '{print $1}'`
 LAST_POOL_DEV=`echo $SCRATCH_DEV_POOL | awk '{print $NF}'`
 TOTAL_DEVS=`echo $SCRATCH_DEV_POOL | wc -w`

